name: Deploy to EC2

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to deploy (leave empty for latest)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.release.tag_name || inputs.release_tag || 'main' }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'squiggle-web/squiggle-ui/package-lock.json'
    
    - name: Get release info
      id: release_info
      run: |
        if [ "${{ github.event_name }}" = "release" ]; then
          echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          echo "release_name=${{ github.event.release.name }}" >> $GITHUB_OUTPUT
        elif [ -n "${{ inputs.release_tag }}" ]; then
          echo "version=${{ inputs.release_tag }}" >> $GITHUB_OUTPUT
          echo "release_name=Manual deployment of ${{ inputs.release_tag }}" >> $GITHUB_OUTPUT
        else
          echo "version=manual-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
          echo "release_name=Manual deployment" >> $GITHUB_OUTPUT
        fi
    
    - name: Build application
      run: |
        cd squiggle-web/squiggle-ui
        npm ci
        echo "Building version: ${{ steps.release_info.outputs.version }}"
        npm run build
    
    - name: Create deployment info
      run: |
        cd squiggle-web/squiggle-ui/dist
        cat > deployment-info.json << EOF
        {
          "version": "${{ steps.release_info.outputs.version }}",
          "release_name": "${{ steps.release_info.outputs.release_name }}",
          "deployed_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
          "commit_sha": "${{ github.sha }}",
          "workflow_run": "${{ github.run_id }}",
          "domain": "${{ secrets.DOMAIN_NAME }}"
        }
        EOF
    
    - name: Deploy to EC2
      uses: easingthemes/ssh-deploy@main
      with:
        SSH_PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
        REMOTE_HOST: ${{ secrets.EC2_HOST }}
        REMOTE_USER: ec2-user
        SOURCE: "squiggle-web/squiggle-ui/dist/"
        TARGET: "/var/www/html/"
        SCRIPT_BEFORE: |
          sudo rm -rf /var/www/html/*
          echo "Deploying ${{ steps.release_info.outputs.release_name }} to ${{ secrets.DOMAIN_NAME }}"
        SCRIPT_AFTER: |
          echo "Deployment completed successfully"
          echo "Version: ${{ steps.release_info.outputs.version }}"
          echo "Available at: https://${{ secrets.DOMAIN_NAME }}"
          sudo systemctl reload nginx







